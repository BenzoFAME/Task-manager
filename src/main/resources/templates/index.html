<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .task-card {
            transition: 0.2s ease-in-out;
            border-radius: 1rem;
        }
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        }
        .timer {
            font-weight: bold;
            font-size: 0.9rem;
        }
        .expired { color: red; }
        .soon { color: orange; }
        .ok { color: green; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="/">Task Manager</a>
        <a class="btn btn-outline-light ms-2" href="/archive">üì¶ –ê—Ä—Ö–∏–≤</a>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addTaskModal">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">üìÅ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        </div>
    </div>

    <!-- ‚úÖ –§–∏–ª—å—Ç—Ä—ã, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –ø–æ–∏—Å–∫ -->
    <div class="card mb-4 p-3">
        <form method="get" action="/" class="row g-2 align-items-end">
            <div class="col-md-3">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select name="categoryId" class="form-select">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
                </select>
            </div>
            <div class="col-md-2">
                <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select name="priority" class="form-select">
                    <option value="">–í—Å–µ</option>
                    <option th:each="p : ${priorities}" th:value="${p}" th:text="${p}"></option>
                </select>
            </div>
            <div class="col-md-2">
                <label>–°—Ç–∞—Ç—É—Å</label>
                <select name="status" class="form-select">
                    <option value="">–í—Å–µ</option>
                    <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
                </select>
            </div>
            <div class="col-md-2">
                <label>–§–∏–ª—å—Ç—Ä</label>
                <select name="filter" class="form-select">
                    <option value="">–í—Å–µ</option>
                    <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</option>
                    <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>
            <div class="col-md-2">
                <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                <select name="sortBy" class="form-select">
                    <option value="">–ü–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                    <option value="dueDate">–ü–æ –¥–µ–¥–ª–∞–π–Ω—É</option>
                    <option value="priority">–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</option>
                </select>
            </div>
            <div class="col-md-3">
                <label>–ü–æ–∏—Å–∫</label>
                <input type="text" name="keyword" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."
                       th:value="${keyword}">
            </div>
            <div class="col-md-2 mt-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            <div class="col-md-1">
                <a href="/clear" class="btn btn-secondary w-100">–û—á–∏—Å—Ç–∏—Ç—å</a>
            </div>
        </form>
    </div>

    <div class="row">
        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="col-md-3">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            th:each="c : ${categories}">
                            <span th:text="${c.name}"></span>
                            <div>
                                <form th:action="@{'/categories/delete/' + ${c.id}}" method="post" class="d-inline m-0">
                                    <button class="btn btn-sm btn-danger">üóëÔ∏è</button>
                                </form>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- –ó–∞–¥–∞—á–∏ -->
        <div class="col-md-9">
            <div class="row" th:if="${tasks.size() > 0}">
                <div class="col-md-6 mb-4" th:each="t : ${tasks}">
                    <div class="card task-card shadow-sm border-0">
                        <div class="card-body">
                            <h5 class="card-title mb-1" th:text="${t.name}"></h5>
                            <p class="text-muted mb-2" th:text="${t.category != null ? t.category.name : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}"></p>
                            <p class="mb-1"><b>–°—Ç–∞—Ç—É—Å:</b> <span th:text="${t.status}"></span></p>
                            <p class="mb-1"><b>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</b> <span th:text="${t.priority}"></span></p>
                            <p class="mb-1"><b>–°—Ä–æ–∫:</b> <span th:text="${t.dueDate}"></span></p>
                            <p class="timer" th:attr="data-duedate=${t.dueDate}"></p>

                            <div class="mt-3 d-flex justify-content-end flex-wrap">
                                <a th:href="@{'/tasks/view/' + ${t.id}}" class="btn btn-sm btn-info me-1 mb-1">üëÅÔ∏è</a>
                                <a th:href="@{'/tasks/edit/' + ${t.id}}" class="btn btn-sm btn-primary me-1 mb-1">‚úèÔ∏è</a>

                                <form th:action="@{'/tasks/archive/' + ${t.id}}" method="post" class="d-inline mb-1">
                                    <button class="btn btn-sm btn-outline-secondary">üì¶</button>
                                </form>

                                <form th:action="@{'/tasks/delete/' + ${t.id}}" method="post" class="d-inline mb-1">
                                    <button class="btn btn-sm btn-danger">üóëÔ∏è</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div th:if="${tasks.size() == 0}" class="text-center text-muted mt-5">
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é!</p>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/categories/save}" method="post">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" name="name" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" required>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form th:action="@{/tasks/save}" method="post" enctype="multipart/form-data">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="text" name="name" class="form-control mb-3" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
                    <textarea name="description" class="form-control mb-3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>

                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select name="category.id" class="form-select">
                                <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                                <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                            <select name="priority" class="form-select">
                                <option th:each="p : ${priorities}" th:value="${p}" th:text="${p}"></option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                            <select name="status" class="form-select">
                                <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
                            </select>
                        </div>
                    </div>

                    <label class="form-label mt-3">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <input type="date" name="dueDate" class="form-control mb-4">

                    <!-- –ü–æ–¥–∑–∞–¥–∞—á–∏ -->
                    <div class="subtasks-section">
                        <label class="form-label">–ü–æ–¥–∑–∞–¥–∞—á–∏</label>
                        <div id="subtasks-container"></div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="addSubtaskBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É</button>
                    </div>

                    <!-- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ -->
                    <label class="form-label mt-3">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                    <input type="file" name="files" multiple class="form-control mb-3">
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-success" type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("subtasks-container");
        const addBtn = document.getElementById("addSubtaskBtn");
        addBtn.addEventListener("click", () => {
            const inputGroup = document.createElement("div");
            inputGroup.classList.add("input-group", "mb-2");
            inputGroup.innerHTML = `
            <input type="text" name="subtask" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥–∑–∞–¥–∞—á—É..." required>
            <button type="button" class="btn btn-outline-danger remove-subtask">‚úñ</button>
        `;
            container.appendChild(inputGroup);
            inputGroup.querySelector(".remove-subtask").addEventListener("click", () => inputGroup.remove());
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function updateTimers() {
        const now = new Date().getTime();
        document.querySelectorAll(".timer").forEach(el => {
            const dueDate = new Date(el.dataset.duedate).getTime();
            if (!dueDate) return;
            const diff = dueDate - now;
            if (diff <= 0) {
                el.textContent = "‚è∞ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ!";
                el.className = "timer expired";
            } else {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
                el.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${days} –¥–Ω ${hours} —á`;
                el.className = "timer " + (days < 1 ? "soon" : "ok");
            }
        });
    }
    setInterval(updateTimers, 1000);
    updateTimers();
</script>
</body>
</html>


